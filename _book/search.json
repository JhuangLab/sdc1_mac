[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "SDC1 Macrophage",
    "section": "",
    "text": "Preface\nThis is a Quarto book of code accompanying our manuscript “Immune evasion in pancreatic cancer driven by a CD138+ tumor-associated macrophage-SiglecF+ neutrophil feedforward loop”.\n\n\n\n\nsessionInfo()\n\nR version 4.4.1 (2024-06-14)\nPlatform: x86_64-conda-linux-gnu\nRunning under: CentOS Linux 8\n\nMatrix products: default\nBLAS/LAPACK: /cluster/apps/anaconda3/2020.02/envs/R-4.4.1/lib/libopenblasp-r0.3.27.so;  LAPACK version 3.12.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Asia/Shanghai\ntzcode source: system (glibc)\n\nattached base packages:\n[1] grid      stats4    stats     graphics  grDevices utils     datasets \n[8] methods   base     \n\nother attached packages:\n [1] survival_3.5-8              survminer_0.4.9            \n [3] data.table_1.15.0           circlize_0.4.16            \n [5] ComplexHeatmap_2.18.0       writexl_1.5.0              \n [7] readxl_1.4.3                paletteer_1.6.0            \n [9] scDblFinder_1.16.0          SingleCellExperiment_1.24.0\n[11] SummarizedExperiment_1.32.0 Biobase_2.62.0             \n[13] GenomicRanges_1.54.1        GenomeInfoDb_1.38.6        \n[15] IRanges_2.36.0              S4Vectors_0.40.2           \n[17] BiocGenerics_0.48.1         MatrixGenerics_1.14.0      \n[19] matrixStats_1.2.0           Seurat_5.0.1               \n[21] SeuratObject_5.0.1          sp_2.1-3                   \n[23] lubridate_1.9.3             forcats_1.0.0              \n[25] dplyr_1.1.4                 purrr_1.0.2                \n[27] readr_2.1.5                 tidyr_1.3.1                \n[29] tibble_3.2.1                tidyverse_2.0.0            \n[31] patchwork_1.2.0.9000        ggsci_3.0.0                \n[33] glue_1.7.0                  jhtools_1.0.0              \n[35] ggthemes_5.1.0              ggpubr_0.6.0               \n[37] ggplot2_3.5.0               stringr_1.5.1              \n[39] configr_0.3.5               fs_1.6.3                   \n\nloaded via a namespace (and not attached):\n  [1] spatstat.sparse_3.0-3     bitops_1.0-7             \n  [3] doParallel_1.0.17         httr_1.4.7               \n  [5] RColorBrewer_1.1-3        tools_4.4.1              \n  [7] sctransform_0.4.1         backports_1.4.1          \n  [9] utf8_1.2.4                R6_2.5.1                 \n [11] lazyeval_0.2.2            uwot_0.1.16              \n [13] GetoptLong_1.0.5          withr_3.0.0              \n [15] gridExtra_2.3             progressr_0.14.0         \n [17] cli_3.6.2                 formatR_1.14             \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] survMisc_0.5.6            spatstat.data_3.0-4      \n [23] ggridges_0.5.6            pbapply_1.7-2            \n [25] Rsamtools_2.18.0          ini_0.3.1                \n [27] scater_1.30.1             parallelly_1.37.0        \n [29] limma_3.58.1              rstudioapi_0.15.0        \n [31] RSQLite_2.3.5             shape_1.4.6              \n [33] generics_0.1.3            BiocIO_1.12.0            \n [35] gtools_3.9.5              ica_1.0-3                \n [37] spatstat.random_3.2-2     car_3.1-2                \n [39] zip_2.3.1                 Matrix_1.6-5             \n [41] futile.logger_1.4.3       ggbeeswarm_0.7.2         \n [43] fansi_1.0.6               abind_1.4-5              \n [45] lifecycle_1.0.4           edgeR_4.0.16             \n [47] yaml_2.3.8                carData_3.0-5            \n [49] gplots_3.1.3.1            SparseArray_1.2.4        \n [51] Rtsne_0.17                blob_1.2.4               \n [53] dqrng_0.3.2               promises_1.2.1           \n [55] crayon_1.5.2              RcppTOML_0.2.2           \n [57] miniUI_0.1.1.1            lattice_0.22-5           \n [59] beachmat_2.18.1           cowplot_1.1.3            \n [61] KEGGREST_1.42.0           metapod_1.10.1           \n [63] pillar_1.9.0              knitr_1.45               \n [65] rjson_0.2.21              xgboost_1.7.7.1          \n [67] future.apply_1.11.1       codetools_0.2-19         \n [69] leiden_0.4.3.1            vctrs_0.6.5              \n [71] png_0.1-8                 spam_2.10-0              \n [73] cellranger_1.1.0          gtable_0.3.4             \n [75] rematch2_2.1.2            cachem_1.0.8             \n [77] xfun_0.42                 openxlsx_4.2.5.2         \n [79] S4Arrays_1.2.0            mime_0.12                \n [81] iterators_1.0.14          KMsurv_0.1-5             \n [83] statmod_1.5.0             bluster_1.12.0           \n [85] ellipsis_0.3.2            fitdistrplus_1.1-11      \n [87] ROCR_1.0-11               nlme_3.1-164             \n [89] bit64_4.0.5               RcppAnnoy_0.0.22         \n [91] irlba_2.3.5.1             vipor_0.4.7              \n [93] KernSmooth_2.23-22        colorspace_2.1-0         \n [95] DBI_1.2.2                 tidyselect_1.2.0         \n [97] bit_4.0.5                 compiler_4.4.1           \n [99] BiocNeighbors_1.20.2      DelayedArray_0.28.0      \n[101] plotly_4.10.4             rtracklayer_1.62.0       \n[103] scales_1.3.0              caTools_1.18.2           \n[105] lmtest_0.9-40             digest_0.6.34            \n[107] goftest_1.2-3             spatstat.utils_3.0-4     \n[109] rmarkdown_2.25            XVector_0.42.0           \n[111] htmltools_0.5.7           pkgconfig_2.0.3          \n[113] sparseMatrixStats_1.14.0  fastmap_1.1.1            \n[115] GlobalOptions_0.1.2       rlang_1.1.3              \n[117] htmlwidgets_1.6.4         DelayedMatrixStats_1.24.0\n[119] shiny_1.8.0               zoo_1.8-12               \n[121] jsonlite_1.8.8            BiocParallel_1.36.0      \n[123] BiocSingular_1.18.0       RCurl_1.98-1.14          \n[125] magrittr_2.0.3            scuttle_1.12.0           \n[127] GenomeInfoDbData_1.2.11   dotCall64_1.1-1          \n[129] munsell_0.5.0             Rcpp_1.0.12              \n[131] viridis_0.6.5             reticulate_1.35.0        \n[133] stringi_1.8.3             zlibbioc_1.48.0          \n[135] MASS_7.3-60.0.1           plyr_1.8.9               \n[137] org.Hs.eg.db_3.18.0       parallel_4.4.1           \n[139] listenv_0.9.1             ggrepel_0.9.5            \n[141] deldir_2.0-2              Biostrings_2.70.2        \n[143] splines_4.4.1             tensor_1.5               \n[145] hms_1.1.3                 locfit_1.5-9.8           \n[147] igraph_2.0.2              spatstat.geom_3.2-8      \n[149] ggsignif_0.6.4            RcppHNSW_0.6.0           \n[151] reshape2_1.4.4            ScaledMatrix_1.10.0      \n[153] futile.options_1.0.1      XML_3.99-0.16.1          \n[155] evaluate_0.23             scran_1.30.2             \n[157] lambda.r_1.2.4            foreach_1.5.2            \n[159] tzdb_0.4.0                httpuv_1.6.14            \n[161] RANN_2.6.1                polyclip_1.10-6          \n[163] km.ci_0.5-6               clue_0.3-65              \n[165] future_1.33.1             scattermore_1.2          \n[167] rsvd_1.0.5                broom_1.0.5              \n[169] xtable_1.8-4              restfulr_0.0.15          \n[171] RSpectra_0.16-1           rstatix_0.7.2            \n[173] later_1.3.2               viridisLite_0.4.2        \n[175] beeswarm_0.4.0            memoise_2.0.1            \n[177] AnnotationDbi_1.64.1      GenomicAlignments_1.38.2 \n[179] tximport_1.30.0           cluster_2.1.6            \n[181] corrplot_0.92             timechange_0.3.0         \n[183] globals_0.16.2            ggfortify_0.4.16"
  },
  {
    "objectID": "Figure1.html#a-umap-of-all-cell-types",
    "href": "Figure1.html#a-umap-of-all-cell-types",
    "title": "1  Figure 1",
    "section": "1.1 (a) UMAP of all cell types",
    "text": "1.1 (a) UMAP of all cell types\n\nhsa_all <- read_rds(\"./data/seu_all_fil1.rds\")\nIdents(hsa_all) <- hsa_all$anot_modified1 %>% as.character() %>% \n  fct(., levels = c(\"Acinar cells\", \"Ductal cells\",\n                    \"CAFs\", \"Stellate cells\",\n                    \"Endothelial cells\", \"Endocrine cells\",\n                    \"Mast cells\", \"Macrophages\", \"Neutrophils\",\n                    \"DC\", \"B cells\", \"T/NK\"))\n\np1 <- DimPlot(hsa_all, reduction = \"rpca_umap\", group.by = \"anot_modified1\",\n              cols = color_cells, raster = T, pt.size = 1.5) + my_theme1 + \n  theme(plot.title = element_blank(), \n        legend.text = element_text(size = 7), legend.position = \"right\") + \n  ggplot2::coord_fixed() + Seurat::NoAxes() \nggsave(\"./results/fig1_s1/fig1a_rpca_umap_all_ctypes.pdf\", \n       p1, width = 7, height = 4.8, unit = \"cm\")\n\n\n\n\n\n\n\n1.1.1 Fig.S1a Cell type markers\nDotplot of cell type markers\n\nendocrine_mks <- c(\"CHGB\", \"GCG\", \"SST\", \"DPP6\", \"KCNMB2\")\nductal_mks <- c(\"KRT19\", \"MMP7\", \"KRT7\", \"KRT8\")\nacinar_mks <- c(\"AMBP\", \"CFTR\", \"PRSS1\", \"CTRB1\", \"CTRB2\")\nstellate_mks <- c(\"RGS5\", \"ACTA2\", \"ADIRF\", \"PDGFRB\")\ncaf_mks <- c(\"LUM\", \"COL1A1\", \"COL1A2\", \"DCN\")\nendo_mks <- c(\"CDH5\", \"PLVAP\", \"VWF\", \"CLDN5\")\nmph_mks <- c(\"AIF1\", \"CD68\", \"CD14\", \"FCGR1A\", \"CD163\")\ndc_mks <- c(\"FLT3\", \"CD1C\", \"XCR1\", \"CLEC9A\", \"BATF3\")\nneutro_mks <- c(\"CSF3R\", \"S100A9\", \"S100A8\", \"MNDA\", \"LST1\")\nmast_mks <- c(\"KIT\", \"CPA3\", \"TPSB2\")\nb_mks <- c(\"MS4A1\", \"CD79A\", \"CD19\", \"CD79B\")\nt_mks <- c(\"CD2\", \"CD3D\", \"CD3E\", \"NKG7\", \"CD8A\", \"CD4\")\n\nmks_lst1 <- c(acinar_mks, ductal_mks, caf_mks, stellate_mks, \n              endo_mks, endocrine_mks, mast_mks, mph_mks, neutro_mks, \n              dc_mks, b_mks, t_mks)\ndot1 <- Seurat::DotPlot(hsa_all, features = mks_lst1, dot.scale = 2.8) + \n  my_theme1 + Seurat::RotatedAxis() + \n  theme(axis.text = element_text(size = 8), \n        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + \n  viridis::scale_color_viridis() + \n  labs(x = \"\", y = \"\") & theme(legend.position = \"bottom\") & \n  scale_size(guide = guide_bins(direction = \"horizontal\"), range = c(.5, 3)) \nggsave(\"results/fig1_s1/figS1a_hsa_all_dot.pdf\", dot1, width = 16, height = 8, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#b-cell-type-proportion",
    "href": "Figure1.html#b-cell-type-proportion",
    "title": "1  Figure 1",
    "section": "1.2 (b) Cell type proportion",
    "text": "1.2 (b) Cell type proportion\n\ndf <- hsa_all@meta.data[, c(\"sample_id\", \"anot_modified1\", \"type2\")] %>% \n  as_tibble(rownames = \"barcode\")\ndf_ctype <- df %>% group_by(type2, anot_modified1) %>% dplyr::summarise(nc = n()) %>%\n  group_by(type2) %>% dplyr::mutate(nt = sum(nc), ratio = nc/nt) %>% ungroup()\n\ndf_ctype$anot_modified1 <- factor(df_ctype$anot_modified1,\n                                  levels = c(\"Acinar cells\", \"Ductal cells\",\n                                             \"CAFs\", \"Stellate cells\",\n                                             \"Endothelial cells\", \"Endocrine cells\",\n                                             \"Mast cells\", \"Macrophages\", \"Neutrophils\",\n                                             \"DC\", \"B cells\", \"T/NK\"))\na <- ggplot(data = df_ctype, mapping = aes(x = type2, fill = anot_modified1, y = nc))+\n  geom_bar(stat = \"identity\", width = 0.5, position = 'fill')+\n  scale_fill_manual(values = color_cells)+\n  scale_y_continuous(labels = scales::percent)+\n  guides(fill=guide_legend(title=\"cell type\"))+\n  labs(x = \"\", y = \"\")+\n  my_theme2 \nggsave(\"./results/fig1_s1/fig1b_bar.pdf\", a, width = 4, height = 5, unit = \"cm\")\n\n\n\n\n\n\n\n\n\n\nProportion change between adjacent tissue and tumor\n\ndf_ctype$type2 <- factor(df_ctype$type2, levels = c(\"Adjacent tissue\", \"Tumor\"))\ndf_sam <- df %>% group_by(sample_id, type2, anot_modified1) %>%\n  dplyr::summarise(nc = n()) %>% group_by(sample_id, type2) %>%\n  dplyr::mutate(nt = sum(nc), ratio = nc/nt) %>% ungroup()\n\nstat_test <- df_sam %>%\n  group_by(anot_modified1) %>% \n  rstatix::wilcox_test(ratio ~ type2, p.adjust.method = \"none\", paired = F)\nstat_test <- stat_test %>% \n  mutate(p.adj.signif = case_when(p >= 0.05 ~ \"ns\",\n                                  p >= 0.01 & p < 0.05 ~ \"*\",\n                                  p >= 0.001 & p < 0.01 ~ \"**\",\n                                  p >= 0.0001 & p < 0.001 ~ \"***\",\n                                  p < 0.0001 ~ \"****\",\n                                  TRUE ~ \"ns\"))\nstat_test <- stat_test %>%\n  rstatix::add_xy_position(x = \"anot_modified1\", dodge = 0.9, fun = \"median_iqr\")\nstat_test$y.position <- 0.3\n\nstat_test <- stat_test %>% \n  dplyr::filter(anot_modified1 %in% c(\"B cells\", \"DC\", \"Macrophages\",\n                                      \"Neutrophils\", \"Mast cells\",\n                                      \"T/NK\"))\ndf_ctype1 <- df_ctype %>% \n  dplyr::filter(anot_modified1 %in% c(\"B cells\", \"DC\", \"Macrophages\",\n                                      \"Neutrophils\", \"Mast cells\",\n                                      \"T/NK\"))\ndf_ctype1$anot_modified1 <- as.character(df_ctype1$anot_modified1)\ndf_ctype1$anot_modified1 <- \n  factor(df_ctype1$anot_modified1, \n         levels = c(\"B cells\", \"DC\", \"Macrophages\", \"Neutrophils\", \n                    \"Mast cells\", \"T/NK\"))\n\np1 <- ggplot(df_ctype1, aes(type2, ratio))+\n  geom_line(aes(group = anot_modified1), size = .5) +\n  geom_point(aes(color = anot_modified1), size = 1.5)+\n  scale_color_manual(values = color_cells)+\n  geom_rangeframe(sides = \"bl\") + \n  scale_y_continuous(expand = expansion(mult = c(0.2, 0.3)))+\n  scale_x_discrete(expand = expansion(mult = c(0.1)))+\n  my_theme3 + labs(x = '', y = '')+\n  facet_wrap(~anot_modified1, ncol=1, strip.position = \"left\")\n\np2 <- p1 +\n  stat_pvalue_manual(stat_test, tip.length = 0.05, \n                     xmin=\"group1\", xmax=\"group2\",\n                     position = position_dodge(0), vjust = 0.5, remove.bracket = F,\n                     label = \"p.adj.signif\", size = 3, hide.ns =T)\nggsave(\"./results/fig1_s1/fig1b_point_line.pdf\", p2, width = 2, height = 6, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#c-tnk-cells",
    "href": "Figure1.html#c-tnk-cells",
    "title": "1  Figure 1",
    "section": "1.3 (c) T/NK cells",
    "text": "1.3 (c) T/NK cells\nBoxplot of T/NK cell frequency in tumor and adjacent tissue\n\nmeta_hsa_all <- read_rds(\"./data/metadata_new.rds\")\ncd45_all <- meta_hsa_all %>% dplyr::select(all_of(c(\"anot_modified1\", \"type2\", \"sample_id\"))) %>% \n  dplyr::filter(anot_modified1 %in% c(\"Macrophages\", \"B cells\", \"T/NK\", \"Neutrophils\", \n                                      \"DC\", \"Mast cells\")) %>% \n  group_by(sample_id) %>% dplyr::add_count() %>% dplyr::rename(\"sum_n\" = \"n\") %>% \n  dplyr::ungroup() %>% dplyr::distinct() %>% dplyr::rename(\"cd45_sum\" = \"sum_n\") %>% .[, 3:4]\n\ntnk_new <- read_rds(\"./data/tnk_anot_fin.rds\")\ndf2 <- tnk_new@meta.data %>% rownames_to_column(\"barcode\") %>% \n  mutate(main_type = \"T/NK\") %>% \n  dplyr::group_by(sample_id, main_type) %>% dplyr::add_count() %>% \n  dplyr::rename('sum_n' = \"n\") %>% \n  dplyr::group_by(sample_id, type2, sum_n, anot_fin) %>% \n  dplyr::count()\ndf3 <- cd45_all %>% left_join(x = ., y = df2) %>% \n  dplyr::rename(\"t_cell_sum\" = \"sum_n\") %>% mutate(cd45_ratio = n / cd45_sum) %>% \n  dplyr::filter(!is.na(type2))\nbox1 <- ggplot2::ggplot(df3, aes(x = type2, y = cd45_ratio, fill = type2)) + \n  ggplot2::geom_boxplot( outlier.size = 0, \n                         width = .5, outlier.alpha = 0) + \n  ggplot2::stat_summary(geom = \"line\", linewidth = .5, fun = \"mean\", color = 'black', group = \"type2\") + \n  ggplot2::stat_summary(geom = \"point\", shape = 21, fill = \"#cFcF00FF\", fun = \"mean\") + \n  ggplot2::facet_wrap(~ anot_fin, nrow = 1) + \n  # theme_classic(base_size = 6) + \n  scale_fill_manual(values = grp_cols) + \n  my_theme2 + theme(axis.title = element_text(size = 8), \n                    axis.ticks.x = element_blank(), \n                    axis.text.x = element_blank()) + \n  labs(x = \"\", y = \"Ratio of CD45+ cells\") + \n  ggpubr::stat_compare_means(aes(group = type2), method = \"wilcox.test\",\n                             hide.ns = F, size = 2, label = \"p.signif\",\n                             bracket.size = .3, label.y = .8, \n                             comparisons = list(c(\"Adjacent tissue\", \"Tumor\"))) +\n  ggplot2::scale_y_continuous(limits = c(0, .9), breaks = c(0.0, 0.2, 0.4, .6, 0.8))\nggsave(\"./results/fig1_s1/fig1c_tcell_cd45_ratio_boxplot.pdf\", box1, width = 6, height = 4, unit = \"cm\")\n\n\n\n\n\n\n\n1.3.1 Fig.S1b UMAP of T/NK cells\n\n# figS1b: 4*4 -----\ndim1 <- Seurat::DimPlot(tnk_new, reduction = \"cca4umap\",  \n                        raster = T, pt.size = 1.5) + \n  my_theme1 + ggplot2::coord_fixed() + Seurat::NoAxes() + \n  theme(legend.position = \"right\", text = element_text(size = 8)) + \n  labs(title = \"\") + \n  scale_color_manual(values = tnk_cols)\nggsave(\"./results/fig1_s1/figS1b_tnk_umap_dim1.pdf\", dim1, width = 7, height = 6, unit = \"cm\")\n\n\n\n\n\n\n\n\n1.3.2 Fig.S1c T/NK cell markers\nDotplot of T/NK cell markers\n\n# figS1c: 3*4 -----\ntnk_feats <- c(\"CD2\", \"CD3D\", \"CD3E\", \"CD4\", \"FOXP3\", \"CCR7\", \n               \"CD8A\", \"CD8B\", \"GZMK\", \"NKG7\", \"KLRD1\", \"GZMB\")\ndot2 <- Seurat::DotPlot(tnk_new, features = tnk_feats, dot.scale = .5) + \n  my_theme1 + Seurat::RotatedAxis() + \n  theme(axis.text = element_text(color = \"black\")) + \n  viridis::scale_color_viridis() + labs(x = \"\", y = \"\") + \n  theme(legend.position = \"right\") + \n  scale_size(range = c(.5, 3))\nggsave(\"./results/fig1_s1/figS1c_tnk_dotplot.pdf\", dot2, width = 9, height = 5, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#d-cytotoxicity-score-of-tnk-cells",
    "href": "Figure1.html#d-cytotoxicity-score-of-tnk-cells",
    "title": "1  Figure 1",
    "section": "1.4 (d) Cytotoxicity score of T/NK cells",
    "text": "1.4 (d) Cytotoxicity score of T/NK cells\n\nssgsea_score <- read_rds(\"./data/tcellsi_ssgsea_score.rds\")\nssgsea_score <- ssgsea_score[, colnames(tnk_new)]\ndf4 <- ssgsea_score %>% t() %>% as.data.frame() %>% \n  mutate(type2 = tnk_new$type2, anot = tnk_new$anot_modified_241020, \n         sample_id = tnk_new$sample_id) \nbox2 <- ggplot2::ggplot(df4, aes(x = type2, y = Cytotoxicity, fill = type2)) + \n  ggplot2::geom_boxplot( outlier.size = 0, \n                         width = .5, outlier.alpha = 0) + \n  ggplot2::stat_summary(geom = \"line\", linewidth = .5, fun = \"mean\", color = 'black', group = \"type2\") + \n  ggplot2::stat_summary(geom = \"point\", shape = 21, fill = \"#cFcF00FF\", fun = \"mean\") + \n  ggplot2::facet_wrap(~ anot, nrow = 1) + \n  theme_classic(base_size = 6) + \n  scale_fill_manual(values = grp_cols) + \n  my_theme2 + theme(axis.ticks.x = element_blank(), \n                    axis.text.x = element_blank(), \n                    legend.position = 'bottom') + \n  labs(x = \"\", y = \"Cytotoxicity score\") + \n  ggpubr::stat_compare_means(aes(group = type2), method = \"wilcox.test\",\n                             hide.ns = F, size = 2, label = \"p.signif\",\n                             label.y.npc = 1.2,\n                             bracket.size = .3, \n                             comparisons = list(c(\"Adjacent tissue\", \"Tumor\"))) +\n  ggplot2::scale_y_continuous(limits = c(0.2, 1.3),\n                              breaks = c(0.2, 0.4, 0.6, 0.8, 1, 1.2))\nggsave(\"./results/fig1_s1/fig1d_tcell_type_cytotoxic_boxplot.pdf\", box2, width = 6, height = 5, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#e-macrophage-subtype",
    "href": "Figure1.html#e-macrophage-subtype",
    "title": "1  Figure 1",
    "section": "1.5 (e) Macrophage subtype",
    "text": "1.5 (e) Macrophage subtype\nUMAP of macrophage subtypes\n\n## colors ----\nhsa_mph_cols <- c(\"HM1\" = \"#1963b3\", \"HM2\" = \"#7ca3b8\", \"HM3\" = \"#97cebf\", \n                  \"HM4\" = \"#789cf2\", \"HM5\" = \"#8071e7\", \"HM6\" = \"#bf88d6\")\n\n# fig1e: 4*4 cm^2 -----\nhsa_mph <- read_rds(\"./data/mph_hsa_seu_anot_fin.rds\")\n\ndim1 <- Seurat::DimPlot(hsa_mph, reduction = \"cca2umap\", pt.size = 1.5, raster = T, \n                        group.by = \"anot_fin\") + my_theme1 + \n  ggplot2::coord_fixed() + scale_color_manual(values = hsa_mph_cols) + \n  Seurat::NoAxes() + labs(title = \"\") + theme(legend.position = \"right\")\nggsave(\"./results/fig1_s1/fig1e_hsa_mph_dim1.pdf\", dim1, width = 5, height = 4.8, unit = \"cm\")\n\n\n\n\n\n\n\n1.5.1 Fig.S1d Macrophage subtype markers\nHeatmap of macrophage subtype markers\n\n# figS1d: -----\nmks_hm1 <- c(\"HILPDA\", \"SLC2A1\", \"EGLN3\", \"HK2\", \"NDRG1\", \"INHBA\")\nmks_hm2 <- c(\"SELENOP\", \"IGF1\", \"C1QC\", \"C1QB\", \"C1QA\", \"HGF\")\nmks_hm3 <- c(\"GTSE1\", \"CDC20\", \"MKI67\", \"TOP2A\", \"UBE2C\", \"RRM2\")\nmks_hm4 <- c(\"EGFR\", \"ITGA2\", \"ARHGEF28\", \"PARD3B\", \"PCDH7\")\nmks_hm5 <- c(\"FCN1\", \"IFIT1\", \"IFIT2\", \"S100A8\", \"IL1B\", \"PTGS2\")\nmks_hm6 <- c(\"CCL18\", \"ACP5\", \"APOC1\", \"FABP5\", \"APOE\")\nmks_hm_lst <- list(hm1 = mks_hm1, hm2 = mks_hm2, hm3 = mks_hm3, hm4 = mks_hm4, \n                   hm5 = mks_hm5, hm6 = mks_hm6)\nnames(mks_hm_lst) <- str_to_upper(names(mks_hm_lst))\n\navg_exps <- \n  Seurat::AverageExpression(hsa_mph, assays = \"RNA\", features = unlist(mks_hm_lst)) %>% \n  .[[1]] %>% as.matrix() %>% t() %>% scale()\ndf1 <- avg_exps %>% as.data.frame() %>% rownames_to_column(\"type\") %>% \n  pivot_longer(cols = -1, names_to = \"gene\", values_to = \"expr\") %>% \n  mutate(gene = fct(as.character(gene), levels = unlist(mks_hm_lst)), \n         type = fct(as.character(type), levels = paste0(\"HM\", 1:6)))\ntile1 <- ggplot2::ggplot(df1, aes(x = gene, y = type, fill = expr)) + \n  ggplot2::geom_tile() + my_theme1 + Seurat::RotatedAxis() + \n  paletteer::scale_fill_paletteer_c(\"grDevices::Viridis\") + \n  labs(y = \"\", x = \"\", fill = \"Z-score\") + ggplot2::coord_flip() + \n  theme(legend.position = \"right\", axis.line = element_blank(), \n        axis.ticks.x = element_blank(), axis.text = element_text(size = 8), \n        panel.border = element_rect(fill = NA, color = \"black\", linewidth = .5))\nggsave(\"./results/fig1_s1/figS1d_hsa_mph_sel_mks_heatmap1.pdf\", tile1, width = 7, height = 10, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#f-macrophage-subtype-proportion",
    "href": "Figure1.html#f-macrophage-subtype-proportion",
    "title": "1  Figure 1",
    "section": "1.6 (f) Macrophage subtype proportion",
    "text": "1.6 (f) Macrophage subtype proportion\n\n## fig1f: bar and lines ---\ncnt_df <- hsa_mph@meta.data %>% dplyr::select(all_of(c(\"anot_fin\", \"type2\"))) %>% \n  group_by(anot_fin, type2) %>% dplyr::count()\nbar2 <- ggplot2::ggplot(cnt_df, aes(x = type2, y = n, fill = anot_fin)) + \n  geom_bar(stat = 'identity', position = \"fill\", width=0.5) + \n  scale_fill_manual(values = hsa_mph_cols) + \n  scale_y_continuous(labels = scales::percent) +\n  guides(fill = guide_legend(title=\"cell type\")) +\n  labs(x = \"\", y = \"\") + my_theme2\nggsave(\"./results/fig1_s1/fig1f_mph_hsa_anot_fin_barplot.pdf\", bar2, width = 4, height = 5, unit = \"cm\")\n\n\n\n\n\n\n\n\n\n\nProportion change between adjacent tissue and tumor\n\n## lines ---\ncnt_df2 <- hsa_mph@meta.data %>% \n  dplyr::select(all_of(c(\"type2\", \"anot_fin\", \"sample_id\"))) %>% \n  group_by(sample_id) %>% dplyr::add_count() %>% dplyr::rename('sum_n' = \"n\") %>% \n  ungroup() %>% dplyr::group_by(sample_id, anot_fin) %>% dplyr::add_count() %>% \n  dplyr::rename(\"celtp_n\" = \"n\") %>% mutate(prop = celtp_n/sum_n) %>% dplyr::distinct()\np1 <- cnt_df2 %>% #dplyr::filter(anot_fin == \"HM5\") %>% \n  ggplot(., aes(x = type2, y = prop))+\n  stat_summary(fun = \"mean\", geom = \"line\", linewidth = .5, \n               group = \"anot_fin\", color = \"black\") +\n  stat_summary(fun = \"mean\", geom = \"point\", size = 1.5,\n               mapping = aes(color = anot_fin)) +\n  scale_color_manual(values = hsa_mph_cols)+\n  geom_rangeframe() +   # 坐标轴分离\n  scale_x_discrete(expand = expansion(mult = c(0.1))) +\n  my_theme3 +\n  labs(x = '', y = '') +\n  facet_wrap(~ anot_fin, ncol=1, strip.position = \"left\") + \n  ggpubr::stat_compare_means(aes(group = type2), \n                             # comparisons = list(c(\"Adjacent tissue\", \"Tumor\")),\n                             method = \"wilcox.test\", size = 2, \n                             hide.ns = T, label = \"p.signif\", \n                             label.y = .6, label.x = 1.43)\nggsave(\"./results/fig1_s1/fig1f_mph_hsa_prop_line.pdf\", p1, width = 2, height = 6, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#g-macrophage-subtype-scores-of-tcga-data",
    "href": "Figure1.html#g-macrophage-subtype-scores-of-tcga-data",
    "title": "1  Figure 1",
    "section": "1.7 (g) Macrophage subtype scores of TCGA data",
    "text": "1.7 (g) Macrophage subtype scores of TCGA data\nHM1 score\n\n## colors -----\ncolor <- c(\"High\" = \"#B92923\", \"Low\" = \"#2F4A99\")\n\n# fig1g: 6*5 ----\nTCGA_tide_m1 <- read_csv(glue(\"./data/TCGA_tide_m1.csv\"))\nvln.df <- TCGA_tide_m1[, c(\"Patient\", \"m1_score\", colnames(TCGA_tide_m1)[17:27])]\nrownames(vln.df) <- vln.df$Patient\nvln.df <- vln.df[, -1]\nvln.df <- pivot_longer(vln.df, cols =!m1_score, \n                       names_to = \"cluster\", values_to = \"level\")\nmy_comparisons <- list(c(\"High\", \"Low\"))\nm1 <- min(TCGA_tide_m1[, \"m1_score\"])\nm2 <- max(TCGA_tide_m1[, \"m1_score\"])\n\nvln.df <- vln.df %>% \n  dplyr::filter(., cluster %in% c(\"CD8_level\", \"Dysfunction_level\", \n                                  \"Exclusion_level\")) %>% \n  mutate(cluster = case_when(cluster == \"Dysfunction_level\" ~ \"Dysfunction\", \n                             cluster == \"Exclusion_level\" ~ \"Exclusion\", \n                             TRUE ~ cluster)) %>% \n  mutate(cluster = gsub(\"_\", \" \", cluster)) %>% \n  mutate(level = factor(level, level = c(\"Low\", \"High\")))\n\nvln4 <- vln.df %>% ggplot(aes(level,m1_score))+\n  ggplot2::geom_violin(aes(fill = level), scale = \"width\", ) +\n  geom_boxplot(width = 0.2, outlier.size = 0, outlier.stroke = NA)+\n  facet_wrap(~cluster) +\n  scale_fill_manual(values=color) +\n  scale_x_discrete(\"\") +\n  scale_y_continuous(limits =c(m1,m2+0.25*(m2-m1)))+\n  my_theme2 + theme(axis.text.x = element_text(angle = 0)) + \n  ylab(\"HM1 score\") +\n  ggpubr::stat_compare_means(method = \"wilcox.test\",size = 2,\n                             label.y = m2 + 0.05*(m2-m1),\n                             label = \"p.signif\", \n                             hide.ns = T, tip.length = .05, \n                             comparisons = list(c(\"Low\", \"High\")))\nggsave(\"./results/fig1_s1/fig1g_boxplot_HM1_gsva_241101.pdf\", vln4, width = 7, height = 3, units = \"cm\")\n\n\n\n\n\n\n\n1.7.1 Fig.S1e HM5/HM6 score\n\nscore_vln_func1 <- function(score_df = NULL, col_nm = NULL, label = NULL) {\n  color <- c(\"High\" = \"#B92923\", \"Low\" = \"#2F4A99\")\n  colnames(score_df) <- \n    gsub(pattern = col_nm, replacement = \"hm_score\", x = colnames(score_df))\n  vln.df <- score_df[,c(\"Patient\", \"hm_score\", colnames(score_df)[17:27])]\n  rownames(vln.df) <- vln.df$Patient\n  vln.df <- vln.df[, -1]\n  vln.df <- pivot_longer(vln.df, cols = !hm_score, names_to = \"cluster\", \n                         values_to = \"level\")\n  my_comparisons <- list(c(\"High\", \"Low\"))\n  m1 <- min(score_df[, \"hm_score\"])\n  m2 <- max(score_df[, \"hm_score\"])\n  \n  vln.df <- vln.df %>% \n    dplyr::filter(., cluster %in% c(\"CD8_level\", \"Dysfunction_level\", \n                                    \"Exclusion_level\")) %>% \n    mutate(level = factor(level, level = c(\"Low\", \"High\")), \n           cluster = case_when(cluster == \"CD8_level\" ~ \"CD8 level\", \n                               cluster == \"Dysfunction_level\" ~ \"Dysfunction\", \n                               cluster == \"Exclusion_level\" ~ \"Exclusion\"))\n  \n  vln4 <- vln.df %>% ggplot(aes(level, hm_score))+\n    ggplot2::geom_violin(aes(fill = level), scale = \"width\")+\n    geom_boxplot(width = 0.2, outlier.size = 0, outlier.stroke = NA)+\n    facet_wrap(~cluster) +\n    scale_fill_manual(values=color) +\n    scale_x_discrete(\"\") + \n    scale_y_continuous(limits =c(m1, m2 + 0.25*(m2-m1)))+\n    my_theme2 + \n    theme(axis.text.x = element_blank(), legend.position = 'right', \n          axis.ticks.x = element_blank()) + \n    ylab(glue(\"{label} score\")) +\n    ggpubr::stat_compare_means(method = \"wilcox.test\",size = 2,\n                               label.y=m2+0.05*(m2-m1),\n                               label = \"p.signif\", \n                               hide.ns = T, tip.length = .05, \n                               comparisons = list(c(\"Low\", \"High\")))\n  return(vln4)\n}\n\nscore_df1 <- read_csv(\"./data/TCGA_tide_h4.csv\")\nvln5 <- score_vln_func1(score_df = score_df1, col_nm = \"h4_score\", label = \"HM5\")\nggsave(\"./results/fig1_s1/figS1e_boxplot_HM5_gsva.pdf\", vln5, width = 10, height = 3, units = \"cm\")\n\n\n\n\n\n\nHM6 score\n\nscore_df2 <- read_csv(\"./data/TCGA_tide_h6.csv\")\nvln6 <- score_vln_func1(score_df = score_df2, col_nm = \"h6_score\", label = \"HM6\")\nggsave(\"./results/fig1_s1/figS1e_boxplot_HM6_gsva.pdf\", vln6, width = 10, height = 3, units = \"cm\")"
  },
  {
    "objectID": "Figure1.html#h-survival-analysis-of-tcga-data",
    "href": "Figure1.html#h-survival-analysis-of-tcga-data",
    "title": "1  Figure 1",
    "section": "1.8 (h) Survival analysis of TCGA data",
    "text": "1.8 (h) Survival analysis of TCGA data\nKaplan-Meier curve stratified by HM1 score\n\nTCGA_tide_m1_surv <- read_csv(\"./data/TCGA_tide_m1_surv.csv\")\nTCGA_tide_m1_surv <- mutate(TCGA_tide_m1_surv, OS.time = OS.time/30)\n\ngrid.draw.ggsurvplot <- function(x) { \n  survminer:::print.ggsurvplot(x, newpage = FALSE)\n}\nfit = survival::survfit(Surv(as.numeric(TCGA_tide_m1_surv$OS.time), \n                             as.numeric(TCGA_tide_m1_surv$OS)) ~ unlist(TCGA_tide_m1_surv[,\"m1_score_level\"]), \n              data =TCGA_tide_m1_surv)\np1 = survminer::ggsurvplot(fit, data = TCGA_tide_m1_surv,\n                           xlab = \"Time in Months\",\n                           legend = c(0.8, 0.8),\n                           legend.title = \"HM1 score level\",\n                           legend.labs = c(\"High\",\"Low\"),\n                           pval = TRUE, pval.size = 2, \n                           pval.coord = c(60 * 0.6, 0.9),\n                           conf.int = F, risk.table = F,\n                           font.tickslab = c(7, \"plain\", \"black\"),\n                           linetype = c(\"solid\", \"solid\"), # Change line type by groups\n                           palette = c(\"High\"=\"#B92923\", \"Low\"=\"#2F4A99\"),\n                           fontsize = 5,\n                           xlim = c(0, 60),\n                           font.legend = 6,\n                           break.time.by = 12,\n                           size = .5, \n                           linewidth = .5, \n                           font.x = c(8, \"black\"),\n                           font.y = c(8, \"black\")) \nggsave(\"./results/fig1_s1/fig1h_TCGA_HM1_score_level_KM_OS.pdf\", \n       p1, width = 5, height = 4, unit = \"cm\")\n\n\n\n\n\n\n\n1.8.1 Fig.S1f\n\n# figS1f -----\nsurv_df0 <- read_csv(\"./data/TCGA_tide_m1_surv.csv\")\nsurv_df1 <- read_csv(\"./data/TCGA_tide_h4_surv.csv\")\nsurv_df2 <- read_csv(\"./data/TCGA_tide_h6_surv.csv\")\n\ntbl1 <- tibble(surv_df_lst = list(surv_df0, surv_df1, surv_df2), \n               nm_lst = c(\"HM1\", \"HM5\", \"HM6\"), \n               numeric_column_lst = c(\"m1_score_level\", \"h4_score_level\", \"h6_score_level\"), \n               fig_num_lst = c(\"tst\", \"figS1f\", \"figS1f\"))\nfor(idx in 2:nrow(tbl1)) {\n  surv_df <- tbl1[[\"surv_df_lst\"]][idx][[1]]\n  nm <- tbl1[[\"nm_lst\"]][idx]\n  numeric_column <- tbl1[[\"numeric_column_lst\"]][idx]\n  fig_num <- tbl1[[\"fig_num_lst\"]][idx]\n  \n  surv_df$OS.time <- surv_df$OS.time/30\n  fit = survfit(Surv(as.numeric(surv_df[[\"OS.time\"]]), \n                     as.numeric(surv_df[[\"OS\"]])) ~ surv_df[[numeric_column]], \n                data =surv_df)\n  p1 = survminer::ggsurvplot(fit, data = surv_df, \n                             xlab = \"Time in Months\",\n                             legend = c(0.8, 0.8),\n                             legend.title = glue(\"{nm} score level\"),\n                             legend.labs = c(\"High\",\"Low\"),\n                             pval = TRUE, pval.size = 2, \n                             pval.coord = c(60 * 0.6, 0.9),\n                             conf.int = F, risk.table = F,\n                             font.tickslab = c(7, \"plain\", \"black\"),\n                             linetype = c(\"solid\", \"solid\"), # Change line type by groups\n                             palette = c(\"High\" = \"#B92923\", \"Low\"=\"#2F4A99\"),\n                             fontsize = 5,\n                             xlim = c(0, 60),\n                             font.legend = 6,\n                             break.time.by = 12,\n                             size = .5, \n                             linewidth = .5, \n                             font.x = c(8, \"black\"),\n                             font.y = c(8, \"black\")) \n  ggsave(glue::glue(\"./results/fig1_s1/{fig_num}_TCGA_{nm}_score_level_KM_OS_241101a.pdf\"), \n         p1, width = 5, height = 5, device = \"pdf\", unit = \"cm\")\n  print(p1)\n}"
  },
  {
    "objectID": "Figure1.html#g-mouse-single-cell-data",
    "href": "Figure1.html#g-mouse-single-cell-data",
    "title": "1  Figure 1",
    "section": "1.9 (g) Mouse single cell data",
    "text": "1.9 (g) Mouse single cell data\nUMAP of all cell types\n\nmmu_mph_cols <- c(\"MM1\" = \"#1963b3\", \"MM2\" = \"#7ca3b8\", \"MM3\" = \"#97cebf\", \n                  \"MM4\" = \"#789cf2\", \"MM5\" = \"#80c187\", \"MM6\" = \"#3f8896\", \n                  \"MM7\" = \"#28c694\")\n\n# fig1i: 4*4 ----\nmmu_all <- read_rds(\"./data/seu_WT_remove_new.rds\")\n\nmmu_dim1 <- Seurat::DimPlot(mmu_all, pt.size = 1.5, raster = T, reduction = \"umap_rpca\",\n                            group.by = \"anot_manual1\") &\n  my_theme1 & Seurat::NoAxes() & theme(legend.position = \"right\") &\n  labs(title = \"\") & scale_color_manual(values = mmu_cols)\nggsave(\"./results/fig1_s1/fig1i_mmu_all_cells_dim1_241101a.pdf\", mmu_dim1, width = 6, height = 4, unit = \"cm\")\n\n\n\n\n\n\n\n1.9.1 Fig.S1g Mouse cell type markers\nDotplot of cell type markers\n\n# figS1g: 15.3*8 or 8*12 -----\nb_mks <- c(\"Cd79a\", \"Cd19\", \"Cd79b\", \"Ms4a1\")\nt_mks <- c(\"Cd3d\", \"Cd3e\", \"Nkg7\", \"Klrd1\", \"Cd4\", \"Cd8a\")\nmono_mks <- c(\"Cd14\", \"Cd44\", \"Cd16\")\nmph_mks <- c(\"Cd68\", \"Adgre1\", \"Fcgr1\", \"Ly6c2\", \"C1qa\", \"C1qb\")\ndc_mks <- c(\"H2-Oa\", \"H2-DMb2\", \"Flt3\", \"Grk3\", \"Htr7\")\nmast_mks <- c(\"Kit\", \"Tpsb2\", \"Cpa3\", \"Hs6st2\", \"Mcpt4\")\nstroma_mks <- c(\"Col1a1\", \"Col1a2\", \"Dcn\", \"Col5a2\", \"Bgn\")\nneutro_mks <- c(\"Csf3r\", \"S100a9\", \"S100a8\", \"Acod1\", \"Hdc\")\nductal_mks <- c(\"Krt18\", \"Krt8\",  \"Epcam\", \"Cdkn2a\", \"Clu\")\n\nIdents(mmu_all) <- mmu_all$anot_manual1 %>% as.character() %>% \n  fct(., levels = c(\"Ductal cells\", \"CAFs\", \"DCs\", \"Mast cells\", \n                    \"Macrophage\", \"Neutrophil\", \"B cells\", \"T/NKs\"))\nmks_lst <- fct(c(ductal_mks, stroma_mks, dc_mks, mast_mks, \n                 mph_mks, neutro_mks, b_mks, t_mks))\n\ndot1 <- mmu_all %>% \n  Seurat::DotPlot(., features = mks_lst, dot.scale = 3, assay = \"RNA\") + \n  my_theme1 + theme(axis.text.x = element_text(angle = 20, hjust = 1, vjust = 1)) + \n  viridis::scale_color_viridis() + labs(x = \"\", y = \"\") + \n  ggplot2::coord_flip() +\n  theme(axis.text = element_text(size = 8), legend.position = \"bottom\") + \n  ggplot2::scale_size(range = c(.5, 2.5))\nggsave(\"./results/fig1_s1/figS1g_mouse_all_cells_dotplot2.pdf\", dot1, width = 8, height = 12, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#j-mouse-macrophage-subtype",
    "href": "Figure1.html#j-mouse-macrophage-subtype",
    "title": "1  Figure 1",
    "section": "1.10 (j) Mouse macrophage subtype",
    "text": "1.10 (j) Mouse macrophage subtype\n\n## fig1k: 6*4 inch\nrds_fn10 <- \n  \"/cluster/home/danyang_jh/projects/panlab/analysis/wangchao/mouse/tenx/merged_new/macrophage/mph_fin/mph_mmu_seu_anot_fin.rds\"\nmmu_mph <- read_rds(\"./data/mph_mmu_seu_anot_fin.rds\")\n\ndim1 <- Seurat::DimPlot(mmu_mph, pt.size = 1e-3, reduction = \"umap\", \n                        group.by = \"anot_fin\", raster = F) + \n  my_theme1 + Seurat::NoAxes() + labs(title = \"\") + \n  ggplot2::coord_fixed() + \n  theme(legend.position = \"right\") + scale_color_manual(values = mmu_mph_cols)\nggsave(\"./results/fig1_s1/fig1j_mmu_mph_dim1.pdf\", dim1, width = 6, height = 4, unit = \"in\")"
  },
  {
    "objectID": "Figure1.html#k-humanmouse-comparison-of-tam-clusters",
    "href": "Figure1.html#k-humanmouse-comparison-of-tam-clusters",
    "title": "1  Figure 1",
    "section": "1.11 (k) Human–mouse comparison of TAM clusters",
    "text": "1.11 (k) Human–mouse comparison of TAM clusters\nCalculate human TAM markers score on mouse\n\n# fig1k -----\ngsea_res <- read_csv(\"./data/gsea_res_mph_hsa2mmu.csv\")\ndot1 <- gsea_res %>% dplyr::arrange(NES) %>% \n  mutate(target = fct(target, levels = paste0(\"MM\", 1:7)), \n         ID = fct(ID, levels = paste0(\"HM\", 1:6))) %>% \n  ggplot2::ggplot(aes(x = ID, y = target, color = NES, size = -log10(pvalue))) + \n  geom_point() + \n  my_theme1 + theme(text = element_text(size = 7)) + \n  ggplot2::scale_colour_gradient2(low = \"navy\", high = \"#f90000\", mid = \"white\") + \n  Seurat::RotatedAxis() + \n  theme(axis.line = element_blank(), axis.text = element_text(color = \"black\"), \n        panel.border = element_rect(fill = NA, color = \"black\", linewidth = .5)) + \n  labs(x = \"\", y = \"\")\nggsave(\"./results/fig1_s1/fig1k_human_mouse_mph_gsea_dot1.pdf\", dot1, width = 7, height = 6, unit = \"cm\")"
  },
  {
    "objectID": "Figure1.html#l-markers-expression-of-human-mouse-tam",
    "href": "Figure1.html#l-markers-expression-of-human-mouse-tam",
    "title": "1  Figure 1",
    "section": "1.12 (l) Markers expression of human-mouse TAM",
    "text": "1.12 (l) Markers expression of human-mouse TAM\nHuman-mouse common markers\n\n# fig1l: 4*4 inch in total\nhuman <- read_rds(\"./data/mph_hsa_seu_anot_fin.rds\")\nmouse <- read_rds(\"./data/mph_mmu_seu_anot_fin.rds\")\n\nIdents(human) <- human$anot_fin\nIdents(mouse) <- mouse$anot_fin\n\nsel_gns_hsa <- c(\"SDC\",\"HILPDA\",\"SLC2A1\",\"EGLN3\",\"HK2\",\"NDRG1\",\"INHBA\",\"MIF\",\"SERPINE1\",\"CXCL3\",\"CXCL2\",\"CXCL1\",\"SAA1\",\"NINJ1\",\"VEGFA\",\n              \"SELENOP\",\"IGF1\",\"C1QC\",\"C1QB\",\"C1QA\",\"GAS6\",\"HGF\",\"AXL\",\n              \"GTSE1\",\"CDC20\",\"DLGAP5\",\"CDCA3\",\"MKI67\",\"TOP2A\",\"UBE2C\",\"RRM2\",\n              \"HMGA2\",\"EGFR\",\"PBX1\",\"ITGA2\",\"SAMD12\",\"ZEB1\",\"MLLT3\")\nsel_gns_mmu <- c(\"Sdc\",\"Hilpda\",\"Slc2a1\",\"Egln3\",\"Hk2\",\"Ndrg1\",\"Inhba\",\"Mif\",\"Serpine1\",\"Cxcl3\",\"Cxcl2\",\"Cxcl1\",\"Saa3\",\"Ninj1\",\"Vegfa\",\n                  \"Selenop\",\"Igf1\",\"C1qc\",\"C1qb\",\"C1qa\",\"Gas6\",\"Hgf\",\"Axl\",\n                  \"Gtse1\",\"Cdc20\",\"Dlgap5\",\"Cdca3\",\"Mki67\",\"Top2a\",\"Ube2c\",\"Rrm2\",\n                  \"Hmga2\",\"Egfr\",\"Pbx1\",\"Itga2\",\"Samd12\",\"Zeb1\",\"Mllt3\")\n\nsdc_gene_hsa <- c(\"SDC1\",\"SDC2\",\"SDC3\",\"SDC4\")\nsdc_gene_mmu <- c(\"Sdc1\",\"Sdc2\",\"Sdc3\",\"Sdc4\")\n\nsdc_expr_hsa <- AverageExpression(human, features = sdc_gene_hsa, assays = \"RNA\",\n                              layer = \"data\") %>% .[[1]] %>% colMeans()\nhsa_mtx <- AverageExpression(human, features = sel_gns_hsa, assays = \"RNA\",\n                             layer = \"data\") %>% .[[1]] %>% as.matrix() %>% \n  t() %>% as.data.frame() %>% mutate(SDC = sdc_expr_hsa) %>% t() %>% \n  .[sel_gns_hsa[1:31], 1:3] %>% t() %>% scale() %>% t() %>% as.matrix()\n\nsdc_expr_mmu <- AverageExpression(mouse, features = sdc_gene_mmu, assays = \"RNA\",\n                              layer = \"data\") %>% .[[1]] %>% colMeans()\nmmu_mtx <-AverageExpression(mouse, features = sel_gns_mmu, assays = \"RNA\", \n                            layer = \"data\") %>% .[[1]] %>% as.matrix() %>% \n  t() %>% as.data.frame() %>% mutate(Sdc = sdc_expr_mmu) %>% t() %>% \n  .[sel_gns_mmu[1:31], 1:3] %>% t() %>% scale() %>% t() %>% as.matrix()\nrownames(mmu_mtx) <- gsub(\"Sdc\", \"Sdc family\", rownames(mmu_mtx))\nrownames(hsa_mtx) <- gsub(\"SDC\", \"SDC family\", rownames(mmu_mtx))\n\nanot_top1 <- ComplexHeatmap::HeatmapAnnotation(species = rep(c(\"human\"), each = 3),\n                                               show_annotation_name = F, \n                                               annotation_width = unit(6, \"mm\"), \n                                               col = list(species = c(\"human\" = \"#dd8811\", \"mouse\" = \"#1188dd\")))\nanot_top2 <- ComplexHeatmap::HeatmapAnnotation(species = rep(c(\"mouse\"), each = 3), \n                                               show_annotation_name = F, \n                                               annotation_width = unit(6, \"mm\"), \n                                               col = list(species = c(\"human\" = \"#dd8811\", \"mouse\" = \"#1188dd\")))\n\ncol_func1 <- circlize::colorRamp2(breaks = c(-1, 0, 1), colors = c(\"blue\", 'white', \"red\"))\nhtp_hsa <- ComplexHeatmap::Heatmap(hsa_mtx, name = \"Z-score\", cluster_rows = F, \n                                   cluster_columns = F, show_row_dend = F, \n                                   show_row_names = T, row_names_side = \"left\", \n                                   row_names_gp = gpar(fontsize = 6), col = col_func1, \n                                   column_names_gp = gpar(fontsize = 7), \n                                   show_heatmap_legend = F, top_annotation = anot_top1)\nhtp_mmu <- ComplexHeatmap::Heatmap(mmu_mtx, name = \"Z-score\", cluster_rows = F, \n                                   cluster_columns = F, show_row_dend = F, \n                                   show_row_names = T, row_names_side = \"right\", \n                                   row_names_gp = gpar(fontsize = 6),  col = col_func1, \n                                   column_names_gp = gpar(fontsize = 7), \n                                   top_annotation = anot_top2)\nhtp_lst <- htp_hsa + htp_mmu\npdf(\"./results/fig1_s1/fig1l_hsa_mmu_common_mks_heatmap.pdf\", width = 4, height = 4)\nComplexHeatmap::draw(htp_lst)\nd <- dev.off()\n\n\n\n\n\n\n\n1.12.1 Fig.S1h Mouse TAM markers\nMouse TAM markers expression on 10x 3’ platform and 10x 5’ platform\n\n# figS1h: mouse markers of 3' and 5' mouse macrophage ----\nmks_mm1 <- c(\"Inhba\", \"Egln3\", \"Hilpda\", \"Ndrg1\", \"Slc2a1\", \"Hk2\")\nmks_mm2 <- c(\"Igf1\", \"Selenop\", \"C1qc\", \"C1qa\", \"C1qb\", \"Hgf\")\nmks_mm3 <- c(\"Rrm2\", \"Ube2c\", \"Top2a\", \"Cdc20\", \"Mki67\", \"Gtse1\")\nmks_mm4 <- c(\"Itga2\", \"Egfr\", \"Arhgef28\", \"Pard3b\", \"Pcdh7\")\nmks_mm5 <- c(\"Il1r2\", \"Fgf13\", \"Ccl17\", \"Klrb1b\", \"Ramp3\")\nmks_mm6 <- c(\"Ly6c2\", \"Sell\", \"Plac8\", \"Chil3\", \"Vcan\")\nmks_mm7 <- c(\"Ccl5\", \"Cxcl9\", \"Gbp2\", \"Gbp4\", \"Cxcl10\", \"Gbp5\")\nmks_mm_lst <- list(mm1 = mks_mm1, mm2 = mks_mm2, mm3 = mks_mm3, mm4 = mks_mm4,\n                   mm5 = mks_mm5, mm6 = mks_mm6, mm7 = mks_mm7)\nnames(mks_mm_lst) <- str_to_upper(names(mks_mm_lst))\n\nmmu_mph <- read_rds(\"./data/mph_mmu_seu_anot_fin.rds\")\navg_exps <- \n  Seurat::AverageExpression(mmu_mph, assays = \"RNA\", features = unlist(mks_mm_lst)) %>% \n  .[[1]] %>% as.matrix() %>% t() %>% scale() %>% t() %>% .[unlist(mks_mm_lst), ]\n\nmmu_mph_2samp <- read_rds(\"./data/seu_2samp.rds\")\navg_exps2 <- \n  Seurat::AverageExpression(mmu_mph_2samp, assays = \"RNA\", features = unlist(mks_mm_lst)) %>% \n  .[[1]] %>% as.matrix() %>% t() %>% scale() %>% t() %>% .[unlist(mks_mm_lst), ]\n\ntop_anot1 <- ComplexHeatmap::HeatmapAnnotation(type = rep(\"10x 3' platform\", 7), \n                                               show_annotation_name = F, \n                                               col = list(type = c(\"10x 3' platform\" = \"#ff8844\")))\nhtp1 <- ComplexHeatmap::Heatmap(avg_exps, show_heatmap_legend = F, \n                                top_annotation = top_anot1, \n                                cluster_rows = F, cluster_columns = F, \n                                row_names_gp = gpar(fontsize = 4), \n                                column_names_gp = gpar(fontsize = 4))\ntop_anot2 <- ComplexHeatmap::HeatmapAnnotation(type = rep(\"10x 5' platform\", 7), \n                                               show_annotation_name = F, \n                                               col = list(type = c(\"10x 5' platform\" = \"#4488ff\")))\nhtp2 <- ComplexHeatmap::Heatmap(avg_exps2, show_heatmap_legend = T, \n                                top_annotation = top_anot2, name = \"Z-score\", \n                                cluster_rows = F, cluster_columns = F, \n                                row_names_gp = gpar(fontsize = 4), \n                                column_names_gp = gpar(fontsize = 4))\nhtp_lst <- htp1 + htp2\npdf(\"./results/fig1_s1/figS1h_mmu_mph_heatmap.pdf\", width = 4, height = 4)\ndraw(htp_lst)\nd <- dev.off()"
  },
  {
    "objectID": "Figure2.html#a-mouse-5-single-cell-data",
    "href": "Figure2.html#a-mouse-5-single-cell-data",
    "title": "2  Figure 2",
    "section": "2.1 (a) Mouse 5’ single cell data",
    "text": "2.1 (a) Mouse 5’ single cell data\nUMAP of mouse macrophage subtypes\n\n## fig2a -----\nseu_2samp <- read_rds(\"./data/seu_2samp.rds\")\ndim1 <- Seurat::DimPlot(seu_2samp, reduction = \"lda_umap\", pt.size = 1e-2) + \n  my_theme1 + Seurat::NoAxes() + \n  ggplot2::coord_fixed() + scale_color_manual(values = mmu_mph_cols)\nggsave(\"./results/fig2/fig2a_mouse_mph_10x_5_dim1.pdf\", dim1, width = 4, height = 3, unit = \"in\")"
  },
  {
    "objectID": "Figure2.html#b-gene-set-enrichment-analysis",
    "href": "Figure2.html#b-gene-set-enrichment-analysis",
    "title": "2  Figure 2",
    "section": "2.2 (b) Gene set enrichment analysis",
    "text": "2.2 (b) Gene set enrichment analysis\nGSEA barplot of MM1 markers\n\n## fig2b -----\npathways <- c(\"GOBP_CELLULAR_RESPONSE_TO_HYPOXIA\", \"GOBP_NEUTROPHIL_CHEMOTAXIS\", \n              \"GOBP_REGULATION_OF_LIPID_TRANSPORT\", \"GOBP_ACUTE_INFLAMMATORY_RESPONSE\", \n              \"GOBP_POSITIVE_REGULATION_OF_SECRETION\", \"GOBP_NEUTROPHIL_HOMEOSTASIS\")\ndw_pths <- \n  c(\"GOBP_IMMUNOGLOBULIN_PRODUCTION_INVOLVED_IN_IMMUNOGLOBULIN_MEDIATED_IMMUNE_RESPONSE\", \n    \"GOBP_REGULATION_OF_NATURAL_KILLER_CELL_MEDIATED_IMMUNITY\", \n    \"GOBP_ANTIGEN_PROCESSING_AND_PRESENTATION_OF_EXOGENOUS_PEPTIDE_ANTIGEN_VIA_MHC_CLASS_II\", \n    \"GOBP_DENDRITIC_CELL_CHEMOTAXIS\", \n    \"GOBP_OXIDATIVE_PHOSPHORYLATION\")\n\ngsea_res <- read_tsv(\"./data/gsea_barplot_result.tsv\") %>% \n  dplyr::filter(`GS<br> follow link to MSigDB` %in% c(pathways, dw_pths)) %>% \n  dplyr::distinct()\nup_labels = c(\"GO:0071456\", \"GO:0090022\", \"GO:0032368\", \"GO:0002526\", \n              \"GO:0051047\", \"GO:0001780\")\ndw_labels = c(\"GO:0002381\", \"GO:0002715\", \"GO:0019886\", \"GO:0002407\", \n              \"GO:0006119\")\nup_col = \"#B92923\" \ndw_col = \"#2F4A99\"\nplot_title = \"GSEA | MM1 TAMs\"\nup_terms = pathways\ndw_terms = dw_pths\n\nup_term2 <- up_terms %>% str_replace_all(\"_\", \" \") %>% str_to_lower()\ndw_term2 <- dw_terms %>% str_replace_all(\"_\", \" \") %>% str_to_lower()\n\nnames(up_labels) <- up_term2\nnames(dw_labels) <- dw_term2\ngsea_sel <- parallel::mclapply(c(up_term2, dw_term2), \\(trm){\n    dplyr::filter(gsea_res, NAME %in% trm) %>% mutate(all_ids = c(up_labels, dw_labels)[trm])\n}, mc.cores = length(c(up_term2, dw_term2))) %>% bind_rows() %>% \n  mutate(trends = case_when(NES > 0 ~ \"up\", TRUE ~ \"down\")) %>% \n  dplyr::group_by(trends) %>% \n  dplyr::arrange(NES) %>% dplyr::mutate(NAME = fct(NAME)) %>% \n  dplyr::mutate(up_ids = case_when(NES > 0 ~ all_ids, TRUE ~ NA), \n                down_ids = case_when(NES < 0 ~ all_ids, TRUE ~ NA)) %>% \n  #### in case there are many matches\n  dplyr::mutate(up_terms = case_when(NES > 0 ~ NAME, TRUE ~ NA), \n                down_terms = case_when(NES < 0 ~ NAME, TRUE ~ NA)) %>% \n  mutate(NAME = NAME %>% str_sub(start = 6) %>% str_to_sentence()) %>% \n  ungroup() %>% dplyr::arrange(NES) %>% mutate(NAME = fct(NAME))\n### plot\ntrnd_cols <- c(\"up\" = up_col, \"down\" = dw_col)\ntst_bar <- ggplot2::ggplot(gsea_sel, aes(x = NES, y = NAME, fill = trends)) + \n  geom_bar(stat = \"identity\") + scale_fill_manual(values = trnd_cols) + \n  geom_text(aes(label = up_terms %>% str_sub(start = 6) %>% stringr::str_replace_all(\"_\", \" \") %>% \n                  str_to_sentence() %>% str_wrap(., width = 40), x = -0.1), \n            size = 1.8, vjust = .5, hjust = 1) + \n  geom_text(aes(label = down_terms %>% str_sub(start = 6) %>% stringr::str_replace_all(\"_\", \" \") %>% \n                  str_to_sentence() %>% str_wrap(., width = 55), x = 0.1), \n            size = 1.8, vjust = .5, hjust = 0) + \n  geom_text(aes(label = up_ids, x = 0.5), size = 2) + \n  geom_text(aes(label = down_ids, x = -0.5), size = 2) + \n  theme_classic(base_size = 8) + \n  theme(axis.title.y = element_blank(), legend.position = \"none\", axis.ticks.y = element_blank(), \n        axis.text.y = element_blank(), axis.line.y = element_blank(), \n        plot.title = element_text(hjust = 0.5), axis.text = element_text(color = \"black\")) + \n  labs(title = plot_title) \nggsave(\"./results/fig2/fig2b_gsea_res_barplot.pdf\", tst_bar, height = 6.5, width = 7.5, unit = \"cm\")"
  },
  {
    "objectID": "Figure2.html#c-function-of-macrophage-subtype-mm1",
    "href": "Figure2.html#c-function-of-macrophage-subtype-mm1",
    "title": "2  Figure 2",
    "section": "2.3 (c) Function of macrophage subtype MM1",
    "text": "2.3 (c) Function of macrophage subtype MM1\nHeatmap of function markers\n\n## fig2c ---- \ngenes_pth1 <- c(\"Cxcl3\", \"Lgals3\", \"Cxcl1\", \"Cxcl2\")\ngenes_pth2 <- c(\"Kdm5b\", \"Mif\", \"P2ry2\", \"Prelid1\")\ngenes_pth3 <- c(\"F7\", \"Adam8\", \"Il6\", \"Saa3\")\ngenes_pth4 <- c(\"Egln3\", \"Bnip3\", \"Bnip3l\", \"Egln1\")\n\npth_genes <- c(genes_pth1, genes_pth2, genes_pth3, genes_pth4)\nexpr_df <- LayerData(seu_2samp[[\"RNA\"]], layer = \"data\")[pth_genes, ] %>% \n  as.matrix() %>% t() %>% as.data.frame() %>% mutate(anot = seu_2samp$anot_fin)\n\ngene_lst <- list(`Neutrophil chemotaxis` = genes_pth1, \n                      `Lipid transport` = genes_pth2, \n                      `Acute inflammatory response` = genes_pth3, \n                      `Cellular response to hypoxia` = genes_pth4)\nplst1 <- lapply(names(gene_lst), \\(nm) {\n  mtx <- Seurat::AverageExpression(seu_2samp, features = gene_lst[[nm]])[[1]] %>% \n    t() %>% scale() %>% t()\n  df1 <- mtx %>% as.data.frame() %>% rownames_to_column(\"gene\") %>% \n    tidyr::pivot_longer(cols = -1, values_to = \"expr\", names_to = \"type\")\n  p1 <- ggplot2::ggplot(df1, aes(x = gene, y = type, fill = expr)) + \n    geom_tile() + my_theme1 + viridis::scale_fill_viridis() + labs(title = nm) + \n    Seurat::RotatedAxis() + labs(y = \"\", x = \"\") + \n    theme(plot.title = element_text(size = 8, hjust = .5), \n          axis.line = element_blank(), \n          axis.ticks = element_blank()) + \n    ggplot2::coord_flip()\n  if(nm != \"Neutrophil chemotaxis\") {\n    p1 <- p1 + \n      Seurat::NoLegend()\n  }\n  return(p1)\n})\np <- patchwork::wrap_plots(plst1, ncol = 1, guides = \"collect\")\nggsave(\"./results/fig2/fig2c_path_genes_tile.pdf\", p, width = 6, height = 14, unit = \"cm\")"
  },
  {
    "objectID": "Figure3.html#a-deg-analysis",
    "href": "Figure3.html#a-deg-analysis",
    "title": "3  Figure 3",
    "section": "3.1 (a) DEG analysis",
    "text": "3.1 (a) DEG analysis\nHeatmap of up-regulated genes in PGE2 & IL34 group.\n\n## fig3a -----\nselected_genes <- read_rds(\"./data/bulk_rna_select_genes.rds\")\nfpkm5 <- read_csv(\"./data/wangchao_mouse_v2.csv\") %>% dplyr::filter(gene_name %in% selected_genes) %>% as.data.frame() %>% \n  tibble::column_to_rownames(\"gene_name\") %>% dplyr::select(-1)\n\n\nvst_dat3 <- fpkm5 %>% t() %>% as.data.frame() %>% \n  mutate(trt = rep(c(\"CTL\", \"PGE2\", \"IL34\", \"PGE2 & IL34\"), each = 2)) %>% \n  aggregate(data = ., . ~ trt, FUN = mean) %>% column_to_rownames(\"trt\") %>% \n  scale() %>% t()\ngene_labs2 <- c(\"Ccr1\", \"Il6\", \"Cxcl1\", \"Nos2\", \"Egln3\", \"Saa3\", \"Inhba\", \n                \"Vcan\", \"Nt5e\", \"F7\", \"Sdc1\", \"F10\", \"Trem1\")\nlabs_idx2 <- which(rownames(vst_dat3) %in% gene_labs2)\n\ntop_anot1 <- \n  ComplexHeatmap::rowAnnotation(foo = anno_mark(at = labs_idx2, \n                                                labels = rownames(vst_dat3)[labs_idx2], \n                                                labels_gp = gpar(fontsize = 6)))\n\ncol_fun = colorRamp2(c(-2, 0, 2), c(\"#3A488AFF\", \"white\", \"#BE3428FF\"))\nhtp1 <- ComplexHeatmap::Heatmap(vst_dat3, show_row_names = F, cluster_columns = F, \n                                # row_names_gp = gpar(fontsize = 4),\n                                right_annotation = top_anot1, \n                                column_names_gp = gpar(fontsize = 8,angle = 45), \n                                name = \"Z-score\", col = col_fun, \n                                height = unit(8, \"cm\"), width = unit(2, \"cm\"))\npdf(\"./results/fig3/fig3a_mks_heatmap.pdf\", width = 3, height = 4)\nprint(htp1)\nd <- dev.off()"
  },
  {
    "objectID": "Figure3.html#b-gsea-plot-of-mm1-driver-genes",
    "href": "Figure3.html#b-gsea-plot-of-mm1-driver-genes",
    "title": "3  Figure 3",
    "section": "3.2 (b) GSEA plot of MM1 driver genes",
    "text": "3.2 (b) GSEA plot of MM1 driver genes\n\n## fig3b: correlated driver genes gsea ----\ntrm2gn2 <- read_rds(\"./data/trm2gn2_bulk_common_genes.rds\")\nmy_theme1 = ggplot2::theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\", size = 8))\n\nmks_df <- read_csv(\"./data/all_to_MM1_lineage_drivers_v2.csv\")\n\ninpt2 <- structure(mks_df[[2]], names = mks_df[[1]])\n\nset.seed(241101)\ntst_res <- clusterProfiler::GSEA(inpt2, TERM2GENE = trm2gn2, minGSSize = 1, \n                                 pvalueCutoff = 1, pAdjustMethod = \"fdr\", seed = T)\npval <- tst_res@result$pvalue %>% signif(., 4)\nnes <- tst_res@result$NES %>% round(digits = 3)\ntst_res@result %>% write_csv(\"bulk_feats_corr_lineage_gsea_res.csv\")\ngsea_p1 <- \n  enrichplot::gseaplot2(tst_res, geneSetID = 1, subplots = 1:2, pvalue_table = F, \n                        color = \"#11aa11FF\", base_size = 7, \n                        title = glue(\"Mouse MM1 Mph: P = {pval} | NES = {nes}\"))\ngsea_p1[[1]] <- gsea_p1[[1]] +   \n  theme(plot.title = element_text(size = 8, hjust = .5))\nggsave(\"./results/fig3/fig3b_bulk_feats_corr_lineage_gsea_dot.pdf\", \n       gsea_p1, width = 7, height = 6, unit = \"cm\")\n\n\n\n\n\n\n\n3.2.1 Fig.S2ab Cell fate analysis of mouse macrophage\nUMAP of pseudotime and fate probability\n\n# 10x 3' Mph data\nmmu_mph <- read_rds(\"./data/mph_mmu_seu_anot_fin.rds\")\n\n## figS2ab: pseudotime and fate probability plot -----\nfeat1 <- Seurat::FeaturePlot(mmu_mph, features = \"monocle3_pseudotime\", pt.size = 1e-2) + \n  my_theme1 + theme(legend.position = \"right\", plot.title = element_text(hjust = .5)) + \n  labs(color = \"\", title = \"Monocle3 pseudotime\") + \n  paletteer::scale_color_paletteer_c(\"grDevices::Sunset\") + \n  ggplot2::coord_fixed() + Seurat::NoAxes()\n\nfeat2 <- Seurat::FeaturePlot(mmu_mph, features = \"fate_prob_MM1\", pt.size = 1e-2) + \n  my_theme1 + theme(legend.position = \"right\", plot.title = element_text(hjust = .5)) + \n  labs(color = \"\", title = \"Fate probability to MM1\") + \n  paletteer::scale_color_paletteer_c(\"grDevices::Plasma\") + \n  ggplot2::coord_fixed() + Seurat::NoAxes()\np <- feat1 | feat2\nggsave(\"./results/fig3/figS2ab_monocle3_cellrank2.pdf\", p, width = 6, height = 3)\n\n\n\n\n\n\n\n\n3.2.2 Fig.S2c Heatmap of fate genes\n\n## figS2c: specific gene heatmap ----\ngenes = c(\"Arg1\", \"Spp1\", \"Gapdh\", \"Basp1\", \"Vegfa\", \"Il1a\", \"Ptgs2\", \n          \"Hilpda\", \"Cxcl2\", \"Slc2a1\", \"Inhba\", \"Prdx6\", \"Egln3\", \n          \"Mt2\", \"Clec4d\", \"Cxcl3\", \"Ndrg1\", \"Bnip3\", \"Ero1l\", \"Srgn\")\npt.matrix <- LayerData(mmu_mph[[\"RNA\"]], layer = \"data\") %>% \n  .[genes, ] %>% as.matrix() %>% t() %>% as.data.frame() %>% \n  mutate(order = mmu_mph$monocle3_pseudotime, anot_fin = mmu_mph$anot_fin, \n         fate_prob = mmu_mph$fate_prob_MM1) %>% \n  dplyr::filter(!is.infinite(order)) %>%\n  dplyr::slice_sample(prop = .1, by = anot_fin) %>%\n  dplyr::arrange(fate_prob)  \npt.matrix2 <- pt.matrix[, 1:20] %>% t() \ngenes <- rownames(pt.matrix2)\nbarcodes <- colnames(pt.matrix2)\npt.matrix2 <- t(apply(pt.matrix2, 1, function(x){smooth.spline(x, df=3)$y}))\npt.matrix2 <- t(apply(pt.matrix2, 1, function(x){(x - mean(x))/sd(x)}))\n\nrownames(pt.matrix2) <- genes\ncolnames(pt.matrix2) <- barcodes\ncol_func1 <- circlize::colorRamp2(breaks = c(0, 16), colors = c(\"white\", \"#cc6611\"))\ncol_func2 <- circlize::colorRamp2(breaks = c(0, 1), colors = c(\"white\", \"darkred\"))\n\ntop_anot1 <- \n  ComplexHeatmap::HeatmapAnnotation(pseudotime = pt.matrix$order[barcodes], \n                                    fate_prob = pt.matrix$fate_prob[barcodes], \n                                    anot = pt.matrix$anot_fin[barcodes], \n                                    col = list(pseudotime = col_func1, \n                                               fate_prob = col_func2, \n                                               anot = mmu_mph_cols))\nhtkm <- ComplexHeatmap::Heatmap(\n  pt.matrix2,\n  name = \"z-score\",\n  show_row_names = TRUE,\n  cluster_rows = T, cluster_columns = F, \n  show_column_names = FALSE,\n  row_names_gp = gpar(fontsize = 7),\n  row_title_rot = 0,\n  cluster_row_slices = FALSE, \n  top_annotation = top_anot1, raster_by_magick = T, \n  height = nrow(pt.matrix2)*unit(3, \"mm\"), \n  width = ncol(pt.matrix2)*unit(.05, \"mm\"))\npdf(\"./results/fig3/figS2c_gene_fate_prob_heatmap.pdf\", width = 4, height = 5)\nprint(htkm)\nd <- dev.off()"
  },
  {
    "objectID": "Figure3.html#c-identified-macrophage-subtypes-in-bulk-rna-data",
    "href": "Figure3.html#c-identified-macrophage-subtypes-in-bulk-rna-data",
    "title": "3  Figure 3",
    "section": "3.3 (c) Identified macrophage subtypes in bulk RNA data",
    "text": "3.3 (c) Identified macrophage subtypes in bulk RNA data\nDotplot of macrophage subtypes score\n\n## fig3c: ----\ngsea_dot_func1 <- function(mk_df = NULL, mph_names = NULL, fn = NULL){\n  gsea_lst <- lapply(mph_names, \\(nm){\n    sel_mks <- mk_df %>% dplyr::filter(cluster == nm)\n    inpt <- structure(sel_mks$avg_log2FC, names = sel_mks$gene) %>% sort() %>% rev()\n    clusterProfiler::GSEA(inpt, TERM2GENE = trm2gn2, minGSSize = 1, \n                          pvalueCutoff = 1, pAdjustMethod = \"fdr\", seed = T)\n  })\n  names(gsea_lst) <- mph_names\n  gsea_res <- lapply(mph_names, \\(nm){\n    gsea_lst[[nm]]@result %>% mutate(celltype = nm)\n  }) %>% bind_rows() %>% dplyr::arrange((NES)) %>% \n    mutate(celltype = fct(as.character(celltype))) %>% \n    mutate(counts = str_split(core_enrichment, \"/\") %>% unlist() %>% length())\n  write_csv(gsea_res, glue(\"fig3b_bulk2sce_gsea_res.csv\"))\n  dot2 <- ggplot2::ggplot(gsea_res, aes(x = NES, y = celltype, size = -log10(p.adjust), color = NES)) + \n    geom_point() + labs(y = \"\") + my_theme1 + \n    ggplot2::scale_x_continuous(limits = c(-4, 4)) + \n    paletteer::scale_color_paletteer_c(\"grDevices::Blue-Red 3\") + \n    theme(legend.position = \"bottom\")\n  return(dot2)\n}\n\nmmu_mph_mks <- read_csv(\"./data/mph_mmu_anot_fin_mks.csv\")\np <- gsea_dot_func1(mk_df = mmu_mph_mks, mph_names = unique(mmu_mph_mks$cluster), fn = \"3samp_mks\")\nggsave(\"./results/fig3/fig3c_bulk2sce_gsea_dot.pdf\", p, width = 6, height = 6, unit = \"cm\")\n\n\n\n\n\n\n\n\n\n\n\n3.3.1 Fig.S2d Function of MM1\n3’ Macrophage MM1 markers enrichment dotplot\n\n# figS2d\nerch_res <- read_csv(\"./data/mph_mm1_kegg_erch_res.csv\")\ntst1 <- erch_res %>% dplyr::filter(grepl(\"Environmental\", category)) %>% \n  dplyr::slice_min(order_by = p.adjust, n = 15) %>% tibble %>% \n  mutate(pth_gene_num = str_split(BgRatio, \"/\", simplify = T)[, 1] %>% as.numeric()) %>% \n  mutate(ratio = Count / pth_gene_num) %>% dplyr::arrange(desc(Count)) %>% \n  dplyr::slice_max(order_by = Count, n = 10) %>% \n  mutate(background = as.numeric(str_split(GeneRatio, \"/\", simplify = T)[, 2])) %>% \n  mutate(x = Count/background)\n\ndot2 <- tst1 %>% dplyr::arrange(desc(x)) %>% \n  mutate(Description = str_wrap(Description, width = 30) %>% fct() %>% fct_rev(), \n  ) %>% \n  ggplot2::ggplot(aes(x = x, y = Description, \n                      color = -log10(p.adjust), size = Count)) + \n  ggplot2::geom_point() + \n  ggplot2::scale_size(range = c(2, 6), breaks = c(10, 20, 30, 40), labels = c(10, 20, 30, 40)) + \n  my_theme1 + paletteer::scale_color_paletteer_c(\"ggthemes::Red\") + \n  theme(axis.text = element_text(size = 7)) + labs(x = \"Gene ratio\", y = \"\") + \n  theme(legend.position = \"bottom\", axis.line = element_blank(), \n        panel.border = element_rect(fill = NA, color = \"black\", linewidth = .5), \n        plot.title = element_text(size = 8, hjust = .5)) + \n  labs(title = \"Environmental information processing\")\nggsave(\"./results/fig3/figS2d_MM1_kegg_enrich_dot2.pdf\", dot2, width = 10, height = 8, unit = \"cm\")"
  }
]